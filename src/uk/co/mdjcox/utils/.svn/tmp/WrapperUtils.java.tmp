/**
 * WrapperUtils.java
 * Author: Michael Cox
 * Date: 27-Jan-2009
 * Time: 18:09:14
 */


package uk.co.mdjcox.utils;


import uk.co.mdjcox.configdb.ConfigDbRemote;
import uk.co.mdjcox.logger.LoggingManager;

import java.io.File;
import java.util.logging.Logger;


public class WrapperUtils {

    private static WrapperUtils instance;
    private static OsUtils osUtils;

    public static WrapperUtils instance(Logger logger) {
        if (instance == null) {
            instance = new WrapperUtils(logger);
        }
        return instance;
    }


    private WrapperUtils(Logger logger) {
        osUtils=OsUtils.instance(logger);
    }

    public void startEncoder(String installDir, String remoteHost,
                             int remotePort) throws Exception {

        String command = "";
        if (File.separatorChar == '\\') {
            command += "cmd.exe /c \"" + installDir + "wrapper" + File.separator
                       + "WebFeedEncoder.bat\" start";
        } else {
            command += "sh -c " + installDir + "wrapper" + File.separator
                       + "WebFeedEncoder.sh start";
        }

        Process process = osUtils.spawnProcess(command, "start", true);

        long waitUntil = System.currentTimeMillis() + 20000;
        while (System.currentTimeMillis() < waitUntil) {
            try {
                ConfigDbRemote configDb = (ConfigDbRemote) RmiHelper
                        .lookup(remoteHost, remotePort, "WebFeedEncoder");
                configDb.ping();
                return;
            } catch (Throwable e) {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e1) {
                }
            }
        }

        try {
            process.destroy();
        } catch (Exception e) {
            e.printStackTrace();
        }
        throw new Exception(
                "Failed to start web feed encoder within 20 seconds");

    }

    public void stopEncoder(String installDir, String remoteHost,
                            int remotePort) throws Exception {
        String command = "";
        if (File.separatorChar == '\\') {
            command += "cmd.exe /c \"" + installDir + "wrapper" + File.separator
                       + "WebFeedEncoder.bat\" stop";
        } else {
            command += "sh -c " + installDir + "wrapper" + File.separator
                       + "WebFeedEncoder.sh stop";
        }

        Process process = osUtils.spawnProcess(command, "stop", true);

        long waitUntil = System.currentTimeMillis() + 20000;
        while (System.currentTimeMillis() < waitUntil) {
            try {
                ConfigDbRemote configDb = (ConfigDbRemote) RmiHelper
                        .lookup(remoteHost, remotePort, "WebFeedEncoder");
                configDb.ping();
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e1) {
                }
            } catch (Throwable e) {
                return;
            }
        }
        try {
            process.destroy();
        } catch (Exception e) {
            e.printStackTrace();
        }
        throw new Exception(
                "Failed to stop web feed encoder within 20 seconds");
    }
}
